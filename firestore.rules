rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function validString(value, min, max) {
      return value is string && value.size() >= min && value.size() <= max;
    }

    function validUserProfileData(data) {
      return data.keys().hasOnly([
        'displayName',
        'email',
        'photoURL',
        'createdAt',
        'lastLoginAt'
      ]) &&
      validString(data.displayName, 0, 80) &&
      validString(data.email, 0, 254) &&
      validString(data.photoURL, 0, 2048) &&
      data.createdAt is timestamp &&
      data.lastLoginAt is timestamp;
    }

    function validGroceryData(data) {
      return data.keys().hasOnly([
        'name',
        'emoji',
        'checked',
        'order',
        'createdAt',
        'updatedAt'
      ]) &&
      validString(data.name, 1, 80) &&
      validString(data.emoji, 1, 8) &&
      data.checked is bool &&
      data.order is int &&
      data.order >= 0 &&
      data.order <= 1000000 &&
      data.createdAt is timestamp &&
      data.updatedAt is timestamp;
    }

    function validCustomEmojiData(data) {
      return data.keys().hasOnly(['emoji', 'updatedAt']) &&
      validString(data.emoji, 1, 8) &&
      data.updatedAt is timestamp;
    }

    match /users/{uid} {
      allow read, delete: if isOwner(uid);
      allow create: if isOwner(uid) && validUserProfileData(request.resource.data);
      allow update: if isOwner(uid) &&
        validUserProfileData(request.resource.data) &&
        request.resource.data.createdAt == resource.data.createdAt;
    }

    match /users/{uid}/groceries/{itemId} {
      allow read, delete: if isOwner(uid);
      allow create: if isOwner(uid) && validGroceryData(request.resource.data);
      allow update: if isOwner(uid) &&
        validGroceryData(request.resource.data) &&
        request.resource.data.createdAt == resource.data.createdAt;
    }

    match /users/{uid}/custom_emojis/{emojiName} {
      allow read, delete: if isOwner(uid);
      allow create, update: if isOwner(uid) && validCustomEmojiData(request.resource.data);
    }
  }
}
